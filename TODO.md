TODO
- Replace some Func stuff with interfaces, so we can use proper dependency injection